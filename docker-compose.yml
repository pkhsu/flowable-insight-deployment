# ============================================
# Flowable Insight - Umbrella Docker Compose
# ============================================
# çµ±ä¸€ç·¨æ’æ‰€æœ‰æœå‹™ (Data Pipeline + Frontend + Backend)
# æ‰€æœ‰ Image çš†ä¾†è‡ªå…¬å¸å…§éƒ¨çš„ Harbor Registry
#
# Target VM è§£å£“å¾Œçš„ç›®éŒ„çµæ§‹:
#   /opt/flowable-insight/
#   â”œâ”€â”€ .env
#   â”œâ”€â”€ docker-compose.yml       <- æœ¬æª”æ¡ˆ
#   â”œâ”€â”€ flowable-ctl.sh
#   â”œâ”€â”€ config/cube/
#   â”œâ”€â”€ data/{clickhouse,cubestore}
#   â””â”€â”€ backup/
# ============================================

services:

  # =============================================
  #  ğŸ“Š Data Pipeline Services (flowable-insight-etl)
  # =============================================

  # --- ClickHouse (Data Storage & ODBC Sync) ---
  clickhouse-server:
    image: ${HARBOR_HOST}/${HARBOR_PROJECT}/flowable-clickhouse-odbc:${CLICKHOUSE_TAG:-latest}
    container_name: flowable_clickhouse
    hostname: clickhouse-server
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-flowable_analytics}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./data/clickhouse:/var/lib/clickhouse
    deploy:
      resources:
        limits:
          memory: 22G
        reservations:
          memory: 8G
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - flowable-network

  # --- Cube Store (Caching Layer) ---
  cubestore:
    image: cubejs/cubestore:v1.5.1
    container_name: flowable_cubestore
    environment:
      CUBESTORE_WORKERS: 1
    volumes:
      - ./data/cubestore:/cube/data
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 2G
    restart: unless-stopped
    networks:
      - flowable-network

  # --- Cube.js API (Semantic Layer) ---
  cube:
    image: cubejs/cube:v1.5.1
    container_name: flowable_cube
    ports:
      - "4000:4000"
    environment:
      CUBEJS_DB_TYPE: clickhouse
      CUBEJS_DB_HOST: clickhouse-server
      CUBEJS_DB_PORT: 8123
      CUBEJS_DB_NAME: ${CLICKHOUSE_DB:-flowable_analytics}
      CUBEJS_DB_USER: ${CLICKHOUSE_USER:-default}
      CUBEJS_DB_PASS: ${CLICKHOUSE_PASSWORD}
      CUBEJS_API_SECRET: ${CUBEJS_API_SECRET}
      CUBEJS_DEV_MODE: "false"
      CUBEJS_CUBESTORE_HOST: cubestore
      CUBEJS_CUBESTORE_PORT: 3030
      CUBEJS_CACHE_AND_QUEUE_DRIVER: cubestore
      CUBEJS_CONCURRENCY: 4
      CUBEJS_DB_MAX_POOL: 8
      CUBEJS_DB_QUERY_TIMEOUT: 600
      CUBEJS_LOG_LEVEL: info
    volumes:
      - ./config/cube:/cube/conf
    depends_on:
      clickhouse-server:
        condition: service_healthy
      cubestore:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - flowable-network

  # --- BFF API Gateway (Node.js) ---
  bff-service:
    image: ${HARBOR_HOST}/${HARBOR_PROJECT}/flowable-bff:${BFF_TAG:-latest}
    container_name: flowable_bff
    environment:
      PORT: 8050
      CUBEJS_API_URL: http://cube:4000/cubejs-api/v1
      CUBEJS_API_SECRET: ${CUBEJS_API_SECRET}
    ports:
      - "8050:8050"
    depends_on:
      cube:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8050/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - flowable-network

  # =============================================
  #  ğŸŒ Application Services (Other Repos)
  # =============================================

  # --- Frontend (React.js) ---
  frontend:
    image: ${HARBOR_HOST}/${HARBOR_PROJECT}/flowable-frontend:${FRONTEND_TAG:-latest}
    container_name: flowable_frontend
    ports:
      - "80:80"
    depends_on:
      - bff-service
      - backend
    restart: unless-stopped
    networks:
      - flowable-network

  # --- Backend (Java + LDAP) ---
  backend:
    image: ${HARBOR_HOST}/${HARBOR_PROJECT}/flowable-backend:${BACKEND_TAG:-latest}
    container_name: flowable_backend
    ports:
      - "8080:8080"
    environment:
      # LDAP / AD é€£ç·š (ç”± Java å¾Œç«¯ä½¿ç”¨)
      LDAP_HOST: ${LDAP_HOST:-ldap.company.local}
      LDAP_PORT: ${LDAP_PORT:-389}
      LDAP_BASE_DN: ${LDAP_BASE_DN:-dc=company,dc=local}
      # è³‡æ–™åº« (å¦‚æœ Backend éœ€è¦è‡ªå·±çš„ DBï¼Œè«‹åœ¨æ­¤è¨­å®š)
      # DB_HOST: ...
    restart: unless-stopped
    networks:
      - flowable-network

networks:
  flowable-network:
    driver: bridge
